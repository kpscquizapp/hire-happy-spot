name: Deploy React Frontend to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Verify API baseURL
        run: |
          echo "ğŸ” Checking baseURL in service.ts"
          grep -R "baseURL" src/services/service.ts || true
          grep -R "http://44.222.35.138/api/api/v1/" src/services/service.ts || true

      - name: Install Dependencies
        run: npm ci

      - name: Build React App
        run: npm run build

      - name: Debug Build Output
        run: |
          echo "ğŸ“ Build folder contents:"
          ls -la build/
          echo "ğŸ“ Build folder size:"
          du -sh build/

      - name: Copy .htaccess (if exists)
        run: |
          if [ -f .htaccess ]; then
            cp .htaccess build/
            echo "âœ… .htaccess copied to build/"
          else
            echo "â„¹ï¸ No .htaccess found"
          fi

      ## STEP 1: Upload build folder via SCP (Fixes permission issue)
      - name: Upload Build to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          port: 22
          source: "build/*"
          target: "/tmp/hireon-fe-build"
          strip_components: 0
          rm: true  # Remove existing target before upload

      ## STEP 2: Deploy via SSH (Now rsync works perfectly)
      - name: Deploy to EC2 (Atomic + Backup)
        uses: appleboy/ssh-action@v1.0.3  # Updated version
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          port: 22
          script: |
            set -e
            
            APP_NAME="hireon-fe"
            BASE_DIR="/var/www/html"
            DEPLOY_DIR="$BASE_DIR/$APP_NAME"
            RELEASE_DIR="$BASE_DIR/${APP_NAME}_release"
            BACKUP_DIR="$BASE_DIR/backups"
            TIMESTAMP=$(date +"%Y%m%d-%H%M%S")

            echo "ğŸ“ Creating required directories"
            sudo mkdir -p "$BACKUP_DIR" "$RELEASE_DIR"

            # Backup existing deployment
            if [ -d "$DEPLOY_DIR" ] && [ "$(ls -A "$DEPLOY_DIR")" ]; then
              echo "ğŸ“¦ Backing up current deployment"
              sudo tar -czf "$BACKUP_DIR/${APP_NAME}-${TIMESTAMP}.tar.gz" -C "$BASE_DIR" "$APP_NAME"
            else
              echo "â„¹ï¸ No existing deployment found"
            fi

            # Clean old backups (keep last 3)
            sudo ls -1t "$BACKUP_DIR"/${APP_NAME}-*.tar.gz 2>/dev/null | tail -n +4 | xargs -r sudo rm -f

            echo "ğŸš€ Deploying new build from /tmp/hireon-fe-build"
            echo "ğŸ“ Checking uploaded files:"
            ls -la /tmp/hireon-fe-build/

            # Atomic deploy
            sudo rm -rf "$RELEASE_DIR"
            sudo rsync -av --delete /tmp/hireon-fe-build/ "$RELEASE_DIR/"
            sudo rm -rf /tmp/hireon-fe-build  # Cleanup temp files

            echo "ğŸ” Switching release (atomic)"
            sudo rm -rf "$DEPLOY_DIR"
            sudo mv "$RELEASE_DIR" "$DEPLOY_DIR"

            echo "ğŸ” Fixing permissions"
            sudo chown -R www-data:www-data "$DEPLOY_DIR"
            sudo chmod -R 755 "$DEPLOY_DIR"
            sudo find "$DEPLOY_DIR" -type f -exec chmod 644 {} \;

            echo "ğŸ”„ Restarting Apache"
            sudo systemctl restart apache2 || sudo systemctl restart httpd

            echo "âœ… Deployment completed successfully"
            echo "ğŸ“ Final deployment contents:"
            ls -la "$DEPLOY_DIR" | head -10
